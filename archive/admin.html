<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PIRLS é–±è®€æ•¸æ“šä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        :root {
            --primary-color: #4169e1;
            --primary-dark: #27408b;
            --secondary-color: #2c3e50;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --text-gray: #64748b;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
        }

        /* --- ç™»å…¥ä»‹é¢å„ªåŒ– --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .login-box {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 10px 25px rgba(65, 105, 225, 0.15);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .login-box h3 { color: var(--primary-color); margin-bottom: 10px; font-size: 1.5rem; }
        .login-box p { color: var(--text-gray); margin-bottom: 25px; font-size: 0.9rem; }
        
        .login-box input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1rem;
            transition: 0.3s;
            outline: none;
        }

        .login-box input:focus { border-color: var(--primary-color); }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-login:active { transform: scale(0.98); }

        /* --- ä¸»ç‰ˆé¢é…ç½® --- */
        #app-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px; /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨ç•™ç™½ */
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 { font-size: 1.5rem; margin: 0; color: var(--secondary-color); }
        .header-title span { color: var(--text-gray); font-size: 0.85rem; }

        .header-actions { display: flex; gap: 10px; }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            transition: 0.2s;
        }

        .btn-home { background: #eff6ff; color: var(--primary-color); }
        .btn-export { background: var(--success-color); color: white; }
        .btn:active { transform: translateY(1px); }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            text-align: center;
            border-bottom: 3px solid var(--primary-color);
        }

        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); line-height: 1.2; }
        .stat-label { color: var(--text-gray); font-size: 0.8rem; margin-top: 5px; }

        /* åœ–è¡¨å€å¡Š */
        .chart-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
        }

        /* è³‡æ–™åˆ—è¡¨å€å¡Š */
        .data-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            background: #fff;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 35px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.95rem;
            background: #f9f9f9;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: #999;
        }

        /* åˆ†é æ§åˆ¶å€ */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 8px;
            flex-wrap: wrap;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all 0.2s;
            font-size: 0.9rem;
            min-width: 36px;
        }

        .page-btn:hover:not(:disabled) {
            background: #f0f2f5;
            border-color: #ccc;
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f9f9f9;
        }

        .page-info {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin: 0 10px;
            font-weight: 500;
        }

        /* RWD è¡¨æ ¼ (Mobile Card View) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            padding: 0;
        }

        thead { background-color: #f8f9fa; }
        th { color: #666; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; text-align: left; padding: 15px; }
        
        tr { border-bottom: 1px solid #eee; }
        td { padding: 15px; font-size: 0.95rem; color: #444; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-class { background: #e3f2fd; color: var(--primary-color); }
        .score-100 { color: var(--success-color); font-weight: bold; }
        .score-pass { color: var(--warning-color); font-weight: bold; }
        .score-fail { color: var(--danger-color); font-weight: bold; }

        /* æ‰‹æ©Ÿç‰ˆæ¨£å¼èª¿æ•´ (Card View) */
        @media screen and (max-width: 768px) {
            .header-actions { width: 100%; }
            .header-actions .btn { flex: 1; justify-content: center; }
            
            /* å¼·åˆ¶è¡¨æ ¼è®Šæˆå¡ç‰‡ */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr {
                margin: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.02);
                background: #fff;
            }
            
            td {
                border: none;
                border-bottom: 1px solid #f5f5f5;
                position: relative;
                padding-left: 40%;
                text-align: right;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            td:last-child { border-bottom: none; }
            
            td:before {
                position: absolute;
                left: 15px;
                width: 35%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #888;
                font-size: 0.85rem;
                content: attr(data-label);
            }

            .stat-value { font-size: 1.5rem; }
        }

        .loading { text-align: center; padding: 40px; color: var(--text-gray); }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- ç™»å…¥ä¿è­· -->
    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ”</div>
            <h3>æ•™å¸«ç®¡ç†å¾Œå°</h3>
            <p>è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å­¸ç”Ÿæ•¸æ“š</p>
            <input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button class="btn-login" onclick="checkPass()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div id="app-container">
        <!-- é ‚éƒ¨å°èˆª -->
        <header>
            <div class="header-title">
                <h1>ğŸ“Š é–±è®€æ•¸æ“šä¸­å¿ƒ</h1>
                <span>å³æ™‚ç›£æ§å­¸ç”Ÿä½œç­”ç‹€æ³</span>
            </div>
            <div class="header-actions">
                <a href="index.html" class="btn btn-home">ğŸ  å›é¦–é </a>
                <button class="btn btn-export" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
            </div>
        </header>

        <!-- æ•¸æ“šçµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-records">...</div>
                <div class="stat-label">ç¸½ä½œç­”äººæ¬¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-score">...</div>
                <div class="stat-label">å¹³å‡åˆ†æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-students">...</div>
                <div class="stat-label">åƒèˆ‡äººæ•¸</div>
            </div>
            <div class="stat-card" style="border-bottom-color: var(--success-color);">
                <div class="stat-value" id="today-records">...</div>
                <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
            </div>
        </div>

        <!-- åœ–è¡¨å€ -->
        <div class="chart-section">
            <h3 style="margin-top:0; color:var(--secondary-color); font-size:1.1rem;">ğŸ“ˆ æˆç¸¾åˆ†ä½ˆæ¦‚æ³</h3>
            <div style="position: relative; height: 200px; width: 100%;">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <!-- è©³ç´°è³‡æ–™åˆ—è¡¨ -->
        <div class="data-section">
            <div class="toolbar">
                <h3 style="margin:0; color:var(--secondary-color); font-size:1.1rem;">ğŸ“ è©³ç´°ç´€éŒ„</h3>
                <div class="search-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="search-input" class="search-input" placeholder="æœå°‹å§“åã€ç­ç´šæˆ–æ–‡ç« ..." onkeyup="filterTable()">
                </div>
            </div>
            
            <div id="table-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>ç­ç´š</th>
                            <th>å§“å</th>
                            <th>åº§è™Ÿ</th>
                            <th>æ–‡ç« æ¨™é¡Œ</th>
                            <th>åˆ†æ•¸</th>
                            <th>è€—æ™‚</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- å…§å®¹ç”± JS ç”¢ç”Ÿ -->
                    </tbody>
                </table>
                <div id="loading-indicator" class="loading">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
                </div>
            </div>

            <!-- åˆ†é æ§åˆ¶ -->
            <div id="pagination-controls" class="pagination-container">
                <!-- ç”± JS ç”¢ç”Ÿåˆ†é æŒ‰éˆ• -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyDpNO7HktKVmMRAEwiKlU1gJ6RTb9qaUm4",
             authDomain: "shimen-pirls.firebaseapp.com",
             projectId: "shimen-pirls",
             storageBucket: "shimen-pirls.firebasestorage.app",
             messagingSenderId: "908294261992",
             appId: "1:908294261992:web:948474ea7c2a662a778d5d"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : "shimen-pirls";
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allData = []; // å„²å­˜æ‰€æœ‰åŸå§‹è³‡æ–™
        let currentFilteredData = []; // å„²å­˜ç›®å‰ç¯©é¸/æœå°‹å¾Œçš„è³‡æ–™
        let chartInstance = null;
        
        // åˆ†é ç›¸é—œè®Šæ•¸
        let currentPage = 1;
        const itemsPerPage = 20; // æ¯é é¡¯ç¤º 20 ç­†

        // å¯†ç¢¼é©—è­‰
        window.checkPass = function() {
            const pass = document.getElementById('admin-password').value;
            if(pass === '034711752' || pass === 'admin') { 
                const overlay = document.getElementById('login-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    initData();
                }, 300);
            } else {
                alert('ğŸš« å¯†ç¢¼éŒ¯èª¤');
            }
        }

        async function initData() {
            try {
                await signInAnonymously(auth);
                loadAllResults();
            } catch(e) {
                console.error("Auth failed", e);
                document.getElementById('loading-indicator').innerHTML = "âš ï¸ è³‡æ–™åº«é€£ç·šå¤±æ•—";
            }
        }

        async function loadAllResults() {
            const loading = document.getElementById('loading-indicator');
            
            try {
                // è®€å–æ‰€æœ‰è³‡æ–™ (ä¸ä½¿ç”¨ limit é™åˆ¶)
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results'), orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                allData = [];
                let totalScore = 0;
                let uniqueStudents = new Set();
                let todayCount = 0;
                const today = new Date().toDateString();
                
                let scoreCounts = { 100: 0, 75: 0, 50: 0, 25: 0, 0: 0 };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let className = data.classId || data.class || "æœªåˆ†ç­";
                    
                    let dateStr = "--/-- --:--";
                    let dateObj = null;
                    if(data.timestamp) {
                        dateObj = data.timestamp.toDate();
                        dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
                        if(dateObj.toDateString() === today) todayCount++;
                    }

                    const score = data.score !== undefined ? Number(data.score) : 0;
                    
                    if (scoreCounts.hasOwnProperty(score)) {
                        scoreCounts[score]++;
                    } else {
                         if(score > 87) scoreCounts[100]++;
                         else if(score > 62) scoreCounts[75]++;
                         else if(score > 37) scoreCounts[50]++;
                         else if(score > 12) scoreCounts[25]++;
                         else scoreCounts[0]++;
                    }

                    const record = {
                        id: doc.id,
                        time: dateStr,
                        rawDate: dateObj,
                        class: className,
                        name: data.studentName || "æœªå…·å",
                        seat: data.seatNumber || "",
                        title: data.articleTitle || `æ–‡ç«  ${data.articleId}`,
                        score: score,
                        duration: data.timeTakenSeconds || 0
                    };

                    allData.push(record);
                    totalScore += record.score;
                    if(record.name !== "æœªå…·å") uniqueStudents.add(record.name + record.class); 
                });

                loading.style.display = 'none';
                
                // åˆå§‹åŒ–é¡¯ç¤ºè³‡æ–™èˆ‡çµ±è¨ˆ
                currentFilteredData = allData;
                renderTable(); // æ¸²æŸ“è¡¨æ ¼ (åŒ…å«åˆ†é é‚è¼¯)
                updateStats(allData.length, totalScore, uniqueStudents.size, todayCount);
                renderChart(scoreCounts);

            } catch (e) {
                console.error("Load data error:", e);
                loading.innerHTML = "<span style='color:red'>è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</span>";
            }
        }

        // æ ¸å¿ƒæ¸²æŸ“å‡½å¼ï¼šè² è²¬åˆ‡åˆ†è³‡æ–™ä¸¦ç”¢ç”Ÿåˆ†é 
        function renderTable() {
            const tbody = document.getElementById('table-body');
            const paginationDiv = document.getElementById('pagination-controls');
            
            if(currentFilteredData.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:30px;'>å°šç„¡è³‡æ–™</td></tr>";
                paginationDiv.innerHTML = "";
                return;
            }

            // è¨ˆç®—ç¸½é æ•¸
            const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
            
            // ç¢ºä¿ currentPage åœ¨æœ‰æ•ˆç¯„åœå…§
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            // è¨ˆç®—ç•¶å‰é é¢è¦é¡¯ç¤ºçš„è³‡æ–™ç¯„åœ
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const displayData = currentFilteredData.slice(start, end);

            // ç”¢ç”Ÿè¡¨æ ¼ HTML
            tbody.innerHTML = displayData.map(row => {
                let scoreClass = 'score-fail';
                let scoreIcon = '';
                if(row.score === 100) { scoreClass = 'score-100'; scoreIcon = 'ğŸ†'; }
                else if(row.score >= 60) { scoreClass = 'score-pass'; }

                return `
                    <tr>
                        <td data-label="æ™‚é–“">${row.time}</td>
                        <td data-label="ç­ç´š"><span class="badge badge-class">${row.class}</span></td>
                        <td data-label="å§“å" style="font-weight:bold;">${row.name}</td>
                        <td data-label="åº§è™Ÿ">${row.seat}</td>
                        <td data-label="æ–‡ç« ">${row.title}</td>
                        <td data-label="åˆ†æ•¸" class="${scoreClass}">${scoreIcon} ${row.score}</td>
                        <td data-label="è€—æ™‚">${row.duration}ç§’</td>
                    </tr>
                `;
            }).join('');

            // ç”¢ç”Ÿåˆ†é æŒ‰éˆ•
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const div = document.getElementById('pagination-controls');
            
            // å¦‚æœåªæœ‰ä¸€é æˆ–æ²’è³‡æ–™ï¼Œåªé¡¯ç¤ºç­†æ•¸
            if (totalPages <= 1) {
                div.innerHTML = `<span class="page-info">å…± ${currentFilteredData.length} ç­†è³‡æ–™</span>`;
                return;
            }

            let html = `
                <button class="page-btn" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>&lt;&lt;</button>
                <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>
            `;

            // æ™ºæ…§åˆ†é é¡¯ç¤º (åªé¡¯ç¤ºç•¶å‰é é¢é™„è¿‘çš„é ç¢¼)
            const maxVisibleButtons = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxVisibleButtons - 1);

            // èª¿æ•´é‚Šç•Œæƒ…æ³
            if (endPage - startPage < maxVisibleButtons - 1) {
                startPage = Math.max(1, endPage - maxVisibleButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            html += `
                <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>
                <button class="page-btn" onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;&gt;</button>
                <span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${currentFilteredData.length} ç­†)</span>
            `;

            div.innerHTML = html;
        }

        // å…¨åŸŸå‡½å¼ä¾› HTML onclick å‘¼å«
        window.changePage = function(page) {
            currentPage = page;
            renderTable();
            // åˆ‡æ›é é¢å¾Œè‡ªå‹•å›åˆ°è¡¨æ ¼é ‚ç«¯
            document.querySelector('.data-section').scrollIntoView({behavior: 'smooth'});
        }

        window.filterTable = function() {
            const input = document.getElementById('search-input').value.toLowerCase();
            
            // é‡æ–°ç¯©é¸è³‡æ–™
            currentFilteredData = allData.filter(item => 
                item.name.toLowerCase().includes(input) || 
                item.class.toLowerCase().includes(input) ||
                item.title.toLowerCase().includes(input)
            );
            
            // æœå°‹å¾Œé‡ç½®å›ç¬¬ä¸€é 
            currentPage = 1;
            renderTable();
        }

        function updateStats(count, totalScore, studentCount, todayCount) {
            const animateValue = (id, end) => {
                const el = document.getElementById(id);
                if(el) el.textContent = end;
            };
            animateValue('total-records', count);
            animateValue('avg-score', count > 0 ? Math.round(totalScore / count) : 0);
            animateValue('total-students', studentCount);
            animateValue('today-records', todayCount);
        }

        function renderChart(scoreCounts) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const labels = ['100åˆ† (å…¨å°)', '75åˆ† (éŒ¯1é¡Œ)', '50åˆ† (éŒ¯2é¡Œ)', '25åˆ† (éŒ¯3é¡Œ)', '0åˆ† (å…¨éŒ¯)'];
            const data = [
                scoreCounts[100],
                scoreCounts[75],
                scoreCounts[50],
                scoreCounts[25],
                scoreCounts[0]
            ];

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'äººæ•¸',
                        data: data,
                        backgroundColor: [
                            'rgba(39, 174, 96, 0.7)',
                            'rgba(41, 128, 185, 0.7)',
                            'rgba(243, 156, 18, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(192, 57, 43, 0.7)'
                        ],
                        borderRadius: 5,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `äººæ•¸: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { display: true, color: '#f0f0f0' },
                            ticks: { precision: 0 } 
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        window.exportCSV = function() {
            // åŒ¯å‡ºåŠŸèƒ½ä½¿ç”¨ currentFilteredDataï¼Œé€™æ¨£å¦‚æœç›®å‰æœ‰æœå°‹ï¼Œå°±åªæœƒåŒ¯å‡ºæœå°‹çµæœ
            // å¦‚æœæƒ³è¦æ°¸é åŒ¯å‡ºã€Œæ‰€æœ‰ã€è³‡æ–™ï¼Œè«‹æ”¹ç”¨ allData
            const dataToExport = currentFilteredData.length > 0 ? currentFilteredData : allData;

            if(dataToExport.length === 0) {
                alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
                return;
            }
            
            let csvContent = "\uFEFF"; 
            csvContent += "ä½œç­”æ™‚é–“,ç­ç´š,å§“å,åº§è™Ÿ,æ–‡ç« æ¨™é¡Œ,åˆ†æ•¸,è€—æ™‚(ç§’)\n";

            dataToExport.forEach(row => {
                const title = `"${row.title.replace(/"/g, '""')}"`; 
                const timeStr = row.rawDate ? `"${row.rawDate.getFullYear()}/${row.rawDate.getMonth()+1}/${row.rawDate.getDate()} ${String(row.rawDate.getHours()).padStart(2,'0')}:${String(row.rawDate.getMinutes()).padStart(2,'0')}"` : "";
                
                csvContent += `${timeStr},${row.class},${row.name},${row.seat},${title},${row.score},${row.duration}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,"");
            link.setAttribute("href", url);
            link.setAttribute("download", `PIRLS_æˆç¸¾åŒ¯å‡º_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>