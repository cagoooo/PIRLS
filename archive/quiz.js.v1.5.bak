// ==========================================================================
// PIRLS é–±è®€ç†è§£æ¸¬é©— - å…±ç”¨ JavaScript é‚è¼¯
// ==========================================================================

// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDocs, query, orderBy, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// ==========================================================================
// Firebase è¨­å®š
// ==========================================================================
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyDpNO7HktKVmMRAEwiKlU1gJ6RTb9qaUm4",
    authDomain: "shimen-pirls.firebaseapp.com",
    projectId: "shimen-pirls",
    storageBucket: "shimen-pirls.firebasestorage.app",
    messagingSenderId: "908294261992",
    appId: "1:908294261992:web:948474ea7c2a662a778d5d"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : "shimen-pirls";

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ==========================================================================
// å…¨åŸŸç‹€æ…‹
// ==========================================================================
let startTime = new Date();
let currentUser = null;
let currentArticle = null; // ç•¶å‰è¼‰å…¥çš„æ–‡ç« è³‡æ–™

// ==========================================================================
// åˆå§‹åŒ–
// ==========================================================================
window.addEventListener('DOMContentLoaded', async () => {
    initClassOptions();

    // å¾ URL å–å¾—æ–‡ç«  ID
    const urlParams = new URLSearchParams(window.location.search);
    const articleId = parseInt(urlParams.get('id'));

    if (!articleId) {
        showError('æ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ç«  IDï¼Œè«‹å¾é¦–é é¸æ“‡æ–‡ç« ã€‚');
        return;
    }

    // è¼‰å…¥æ–‡ç« è³‡æ–™
    try {
        const response = await fetch('data/questions.json?t=' + Date.now());
        if (!response.ok) throw new Error('è¼‰å…¥é¡Œåº«å¤±æ•—');

        const articles = await response.json();
        currentArticle = articles.find(a => a.id === articleId);

        if (!currentArticle) {
            showError(`æ‰¾ä¸åˆ°ç·¨è™Ÿ ${articleId} çš„æ–‡ç« ï¼Œè«‹è¿”å›é¦–é é‡æ–°é¸æ“‡ã€‚`);
            return;
        }

        // æ¸²æŸ“é é¢
        renderArticle();
        renderQuestions();

        // æ›´æ–°æ¨™é¡Œ
        document.getElementById('article-title-display').textContent = `é–±è®€æ–‡ç« ï¼š${currentArticle.title}`;
        document.title = `é–±è®€ç†è§£ç·´ç¿’ï¼š${currentArticle.title}`;

    } catch (e) {
        console.error('è¼‰å…¥æ–‡ç« å¤±æ•—:', e);
        showError('è¼‰å…¥é¡Œåº«å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚');
        return;
    }

    // æª¢æŸ¥ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
    checkUserLogin();

    // Firebase åŒ¿åç™»å…¥
    try {
        await signInAnonymously(auth);
        if (currentUser) loadHistory();
    } catch (e) {
        console.error("Auth Error", e);
    }
});

// ==========================================================================
// ç­ç´šé¸é …åˆå§‹åŒ–
// ==========================================================================
function initClassOptions() {
    const select = document.getElementById('classNumberSelect');
    if (!select) return;

    for (let i = 1; i <= 6; i++) {
        const opt = document.createElement('option');
        opt.value = `${i}ç­`;
        opt.textContent = `${i}ç­`;
        select.appendChild(opt);
    }

    const extras = ["7ç­", "8ç­", "9ç­", "10ç­", "å…¶ä»–"];
    extras.forEach(ex => {
        const opt = document.createElement('option');
        opt.value = ex;
        opt.textContent = ex;
        select.appendChild(opt);
    });
}

// ==========================================================================
// æ¸²æŸ“æ–‡ç« å…§å®¹
// ==========================================================================
function renderArticle() {
    const articleBody = document.getElementById('article-body');
    if (!articleBody || !currentArticle) return;

    articleBody.innerHTML = currentArticle.content
        .map(paragraph => `<p>${paragraph}</p>`)
        .join('');
}

// ==========================================================================
// æ¸²æŸ“å•é¡Œå€
// ==========================================================================
function renderQuestions() {
    const container = document.getElementById('questions-container');
    if (!container || !currentArticle) return;

    container.innerHTML = currentArticle.questions.map((q, index) => {
        const qNum = index + 1;
        const optionLabels = ['a', 'b', 'c', 'd', 'e'];

        return `
            <div class="question" id="q-block-${qNum}">
                <p>${qNum}. ${q.question}ï¼ˆ${q.type}ï¼‰</p>
                ${q.options.map((opt, optIndex) => `
                    <label class="option">
                        <input type="radio" name="q${qNum}" value="${optionLabels[optIndex]}">
                        ${opt}
                    </label>
                `).join('')}
                <div class="explanation" id="exp${qNum}"></div>
            </div>
        `;
    }).join('');
}

// ==========================================================================
// ä½¿ç”¨è€…ç™»å…¥æª¢æŸ¥
// ==========================================================================
function checkUserLogin() {
    const storedUser = localStorage.getItem('shimen_pirls_user');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        updateUserUI();
        document.getElementById('loginModal').style.display = 'none';
    } else {
        document.getElementById('loginModal').style.display = 'flex';
    }
}

// ==========================================================================
// å„²å­˜ä½¿ç”¨è€…è³‡è¨Š
// ==========================================================================
window.saveUserInfo = function () {
    const grade = document.getElementById('gradeSelect').value;
    const classNum = document.getElementById('classNumberSelect').value;
    const name = document.getElementById('studentName').value.trim();
    const seat = document.getElementById('seatNumber').value.trim();

    if (!grade || !classNum || !name) {
        alert("è«‹å®Œæ•´é¸æ“‡å¹´ç´šã€ç­ç´šä¸¦è¼¸å…¥å§“åï¼");
        return;
    }

    const finalClass = `${grade}å¹´${classNum}`;

    currentUser = {
        class: finalClass,
        name: name,
        seat: seat,
        fullId: `${finalClass}-${seat ? seat + '-' : ''}${name}`
    };

    localStorage.setItem('shimen_pirls_user', JSON.stringify(currentUser));
    updateUserUI();
    document.getElementById('loginModal').style.display = 'none';
    startTime = new Date();
    loadHistory();
};

// ==========================================================================
// åˆ‡æ›ä½¿ç”¨è€…
// ==========================================================================
window.resetUser = function () {
    console.log("resetUser called - switching user"); // DEBUG
    localStorage.removeItem('shimen_pirls_user');
    location.reload();
};

// ==========================================================================
// æ›´æ–°ä½¿ç”¨è€… UI
// ==========================================================================
function updateUserUI() {
    if (!currentUser) return;

    const displayStr = `${currentUser.class} ${currentUser.name}`;

    const mobileUserName = document.getElementById('mobile-user-name');
    const desktopUserName = document.getElementById('desktop-user-name');

    if (mobileUserName) mobileUserName.textContent = displayStr;
    if (desktopUserName) desktopUserName.textContent = displayStr;
}

// ==========================================================================
// æäº¤ç­”æ¡ˆ
// ==========================================================================
window.checkAnswers = async function () {
    if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        location.reload();
        return;
    }

    if (!currentArticle) {
        alert("æ–‡ç« è³‡æ–™å°šæœªè¼‰å…¥ï¼");
        return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = "è©•åˆ†èˆ‡å„²å­˜ä¸­...";

    let score = 0;
    let answersRecord = {};
    const totalQuestions = currentArticle.questions.length;

    for (let i = 1; i <= totalQuestions; i++) {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        const expDiv = document.getElementById(`exp${i}`);
        const userVal = selected ? selected.value : "";
        const correctVal = currentArticle.questions[i - 1].answer;

        answersRecord[`q${i}`] = userVal;

        expDiv.className = "explanation show";
        if (userVal === correctVal) {
            score++;
            expDiv.innerHTML = `âœ… <strong>æ­£ç¢ºï¼</strong>`;
            expDiv.classList.add("correct");
            expDiv.classList.remove("incorrect");
        } else {
            expDiv.innerHTML = `âŒ <strong>éœ€è¦è¤‡ç¿’ï¼š</strong> ${currentArticle.questions[i - 1].hint}`;
            expDiv.classList.add("incorrect");
            expDiv.classList.remove("correct");
        }
    }

    const finalScore = Math.round((score / totalQuestions) * 100);
    const timeTaken = Math.round((new Date() - startTime) / 1000);

    const statsDiv = document.getElementById('current-stats');
    statsDiv.style.display = 'block';
    statsDiv.innerHTML = `
        <h3 style="margin-top:0; color: #00008b;">ğŸ“ æœ¬æ¬¡æ¸¬é©—çµæœ</h3>
        <div style="display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px;">
            <div style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color:${finalScore === 100 ? '#28a745' : '#dc3545'}">${finalScore}</div>
                <div style="font-size: 0.9rem; color: #666;">å¾—åˆ†</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #4169e1;">${timeTaken}</div>
                <div style="font-size: 0.9rem; color: #666;">ç§’æ•¸</div>
            </div>
        </div>
        <p style="text-align: center; margin: 0; font-size: 0.9rem; color: #888;">æˆç¸¾å·²ä¸Šå‚³é›²ç«¯</p>
    `;

    // æ»¾å‹•åˆ°æˆç¸¾å€
    const offset = 100;
    const elementPosition = statsDiv.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - offset;

    window.scrollTo({
        top: offsetPosition,
        behavior: "smooth"
    });

    // å„²å­˜è‡³ Firebase
    try {
        const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
        const recordData = {
            classId: currentUser.class,
            studentName: currentUser.name,
            seatNumber: currentUser.seat,
            studentFullId: currentUser.fullId,
            articleId: currentArticle.id,
            articleTitle: currentArticle.title,
            score: finalScore,
            answers: answersRecord,
            timeTakenSeconds: timeTaken,
            timestamp: serverTimestamp(),
            deviceInfo: navigator.userAgent
        };

        // é›™é‡å¯«å…¥æ©Ÿåˆ¶
        addDoc(publicRef, recordData).catch(e => console.warn("Public write failed:", e));

        // å¯«å…¥å€‹äººè³‡æ–™åº«
        if (auth.currentUser) {
            const userRef = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'quiz_results');
            await addDoc(userRef, recordData);
        }

        // æ›´æ–°é¦–é çµ±è¨ˆ
        const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'pirls_stats', `pirls_${currentArticle.id}`);
        setDoc(statsRef, {
            count: increment(1),
            title: currentArticle.title
        }, { merge: true }).catch(e => console.warn("Stats update failed:", e));

        // é‡æ–°è¼‰å…¥æ­·å²
        setTimeout(loadHistory, 500);

    } catch (error) {
        console.error("Save Error:", error);
        alert("æˆç¸¾å·²é€å‡ºï¼Œä½†ç„¡æ³•å„²å­˜è‡³é›²ç«¯ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–è«‹ç®¡ç†å“¡æª¢æŸ¥è³‡æ–™åº«æ¬Šé™ã€‚");
    } finally {
        btn.disabled = false;
        btn.textContent = "å†æ¬¡æäº¤ (æ›´æ–°æˆç¸¾)";
        startTime = new Date();
    }
};

// ==========================================================================
// è¼‰å…¥æ­·å²ç´€éŒ„
// ==========================================================================
async function loadHistory() {
    if (!currentUser || !currentArticle) return;

    const listDiv = document.getElementById('history-list');
    if (!listDiv) return;

    listDiv.innerHTML = '<div style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</div>';

    const targetClass = currentUser.class;
    const targetName = currentUser.name;

    try {
        const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
        const q = query(publicResultsRef, orderBy('timestamp', 'desc'));

        const snapshot = await getDocs(q);

        let records = [];

        snapshot.forEach((doc) => {
            const data = doc.data();

            const recordClass = data.classId || data.class || "";
            const recordName = data.studentName || data.name || "";

            // ç¯©é¸ä½¿ç”¨è€…èˆ‡æ–‡ç« 
            if (String(recordClass).trim() === String(targetClass).trim() &&
                String(recordName).trim() === String(targetName).trim()) {

                if (data.articleId == currentArticle.id) {
                    records.push({
                        ...data,
                        date: data.timestamp ? data.timestamp.toDate() : new Date()
                    });
                }
            }
        });

        if (records.length === 0) {
            listDiv.innerHTML = "<p style='color:#888; text-align:center;'>å°šç„¡æœ¬ç¯‡æ–‡ç« çš„ç·´ç¿’ç´€éŒ„ã€‚</p>";
            return;
        }

        listDiv.innerHTML = records.map(r => {
            const dateStr = r.date.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const scoreClass = r.score === 100 ? 'high-score' : (r.score < 60 ? 'low-score' : '');
            return `
                <div class="history-item ${scoreClass}">
                    <div style="display:flex; align-items:center;">
                        <div style="font-weight:bold; font-size:1.1rem; margin-right:10px; width: 50px;">${r.score}åˆ†</div>
                        <div style="font-size:0.85rem; color:#666;">è€—æ™‚ ${r.timeTakenSeconds}ç§’</div>
                    </div>
                    <div style="font-size:0.8rem; color:#999;">${dateStr}</div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error("Load History Error:", error);
        listDiv.innerHTML = `<p style='color:red; font-size:0.8rem;'>è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</p>`;
    }
}

// ==========================================================================
// éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
// ==========================================================================
function showError(message) {
    // éš±è—ç™»å…¥ Modal
    const modal = document.getElementById('loginModal');
    if (modal) modal.style.display = 'none';

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    const centerColumn = document.getElementById('center-column');
    if (centerColumn) {
        centerColumn.innerHTML = `
            <div class="error-message">
                <h2>âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
                <p>${message}</p>
                <p><a href="index.html">â† è¿”å›é¦–é </a></p>
            </div>
        `;
    }

    // éš±è—å³å´æ¬„
    const rightColumn = document.getElementById('right-column');
    if (rightColumn) rightColumn.style.display = 'none';
}
