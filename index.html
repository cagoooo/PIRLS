<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ³é–€åœ‹å°PIRLSé–±è®€ç†è§£å…¥å£ç¶²</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #ff0844, #ffb199, #ff1361, #ff3d7f);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        #header-container {
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
            position: relative;
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é ‚éƒ¨å·¥å…·åˆ—ï¼šåŒ…å«æ­¡è¿è©èˆ‡åŒ¯å‡ºæŒ‰éˆ• */
        .top-bar {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
        }

        /* ä½¿ç”¨è€…æ­¡è¿æ¨™ç±¤ */
        #user-greeting-badge {
            background: rgba(255, 255, 255, 0.25);
            padding: 8px 16px;
            border-radius: 30px;
            color: white;
            backdrop-filter: blur(5px);
            font-size: 0.95rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
            /* JS æ§åˆ¶é¡¯ç¤º */
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s;
            cursor: default;
        }

        #user-greeting-badge:hover {
            transform: translateY(-2px);
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .action-btn {
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: none;
            /* JS æ§åˆ¶é¡¯ç¤º */
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        /* åŒ¯å‡ºæŒ‰éˆ• (å€‹äºº) */
        #export-btn {
            background: #ffffff;
            color: #ff1361;
        }

        #export-btn:hover {
            background: #fff0f5;
        }

        /* ç™»å‡ºæŒ‰éˆ• */
        #logout-btn {
            background: #ff4757;
            color: white;
        }

        #logout-btn:hover {
            background: #ff6b81;
        }

        /* éš±è—çš„ç®¡ç†å“¡åŒ¯å‡ºæŒ‰éˆ• (å³ä¸‹è§’) */
        #admin-trigger {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 2rem;
            opacity: 0.1;
            /* å¹³å¸¸å¹¾ä¹çœ‹ä¸è¦‹ */
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 9999;
            user-select: none;
        }

        #admin-trigger:hover {
            opacity: 1;
            /* æ»‘é¼ ç§»éå»è®Šæ˜é¡¯ */
            transform: scale(1.2);
        }

        /* éš±è—çš„å¾Œå°é€£çµæŒ‰éˆ• (å·¦ä¸‹è§’) */
        #admin-link-btn {
            position: fixed;
            bottom: 15px;
            left: 15px;
            font-size: 2rem;
            opacity: 0.1;
            /* å¹³å¸¸å¹¾ä¹çœ‹ä¸è¦‹ */
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 9999;
            user-select: none;
        }

        #admin-link-btn:hover {
            opacity: 1;
            /* æ»‘é¼ ç§»éå»è®Šæ˜é¡¯ */
            transform: scale(1.2);
        }

        #mainTitle {
            font-size: 3.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
            margin: 0;
            padding-top: 10px;
            text-align: center;
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œèª¿æ•´ */
        @media (max-width: 768px) {
            #mainTitle {
                font-size: 2.2rem;
            }

            .top-bar {
                flex-direction: column;
                align-items: center;
                margin-bottom: 15px;
            }

            #header-container {
                margin-top: 1rem;
            }
        }

        #total-stats {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            padding: 0.8rem 2rem;
            border-radius: 50px;
            display: inline-block;
            margin-top: 1.5rem;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease;
        }

        #total-stats:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.35);
        }

        #total-count {
            font-weight: 800;
            font-size: 1.5rem;
            margin-left: 0.5rem;
            color: #fff700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-family: 'Courier New', Courier, monospace;
            /* æ•¸å­—é¢¨æ ¼ */
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
            z-index: 1;
            /* ç¢ºä¿åœ¨ç²’å­ä¹‹ä¸Š */
        }

        .grid-item {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            text-decoration: none;
            color: #333;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .grid-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            background-color: #fff;
            border-color: #ff3d7f;
        }

        .grid-item:active {
            transform: scale(0.98);
        }

        .article-content {
            padding: 1.5rem 1.5rem 0.5rem 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .article-title {
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
            line-height: 1.5;
            color: #444;
            margin-bottom: 10px;
        }

        .grid-item:hover .article-title {
            color: #ff1361;
        }

        /* å…¨ç«™çµ±è¨ˆèˆ‡å€‹äººçµ±è¨ˆçš„åˆ†éš” */
        .stats-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .article-public-stats {
            padding: 0.6rem 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        /* å€‹äººæˆç¸¾å€å¡Š - RWD å„ªåŒ– */
        .user-personal-stats {
            padding: 0.6rem 1.2rem;
            background-color: #e8f5e9;
            /* æ·ºç¶ è‰²èƒŒæ™¯ */
            font-size: 0.8rem;
            display: flex;
            flex-wrap: wrap;
            /* å…è¨±æ›è¡Œ */
            justify-content: space-between;
            align-items: center;
            min-height: 42px;
            gap: 5px;
        }

        .view-count-badge {
            font-weight: bold;
            color: #ff3d7f;
            background: rgba(255, 61, 127, 0.1);
            padding: 3px 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* åˆ†æ•¸èˆ‡æ™‚é–“æ¨™ç±¤ */
        .stat-badge {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .score-text {
            font-weight: bold;
            color: #2e7d32;
        }

        .time-text {
            color: #1565c0;
            /* è—è‰² */
        }

        .count-text {
            color: #e65100;
            /* æ©˜è‰² */
            font-size: 0.75rem;
        }

        .no-record {
            color: #999;
            font-style: italic;
            width: 100%;
            text-align: center;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            pointer-events: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff1361;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Toast é€šçŸ¥ç³»çµ±æ¨£å¼ -->
    <link rel="stylesheet" href="assets/css/toast.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div id="particles-js"></div>

    <div id="header-container">
        <!-- é ‚éƒ¨å·¥å…·åˆ—ï¼šåŒ…å«æ­¡è¿è©èˆ‡åŒ¯å‡ºæŒ‰éˆ• -->
        <div class="top-bar">
            <div id="user-greeting-badge"></div>
            <button id="export-btn" class="action-btn" onclick="exportUserRecords()">
                ğŸ“¥ åŒ¯å‡ºæˆ‘çš„æ­·ç¨‹
            </button>
            <button id="logout-btn" class="action-btn" onclick="logoutUser()">
                ğŸšª ç™»å‡º
            </button>
        </div>

        <h1 id="mainTitle">
            çŸ³é–€åœ‹å°PIRLSé–±è®€ç†è§£ç¶²
        </h1>
        <div id="total-stats">
            å…¨ç«™ç´¯ç©é–±è®€äººæ¬¡ï¼š<span id="total-count">è¼‰å…¥ä¸­...</span>
        </div>
    </div>


    

    <!-- å­¸ç¿’é€²åº¦å„€è¡¨æ¿ -->
    <div id="progressDashboard" class="progress-dashboard" style="display: none;"></div>

    <!-- v1.8: Completion Status Filter -->
    <div class="filter-status-container">
        <h3>ğŸ“Š å­¸ç¿’é€²åº¦ç¯©é¸ï¼š</h3>
        <div class="status-filters">
            <button class="status-btn active" data-filter="all">
                ğŸ“š å…¨éƒ¨ (<span id="countAll">--</span>)
            </button>
            <button class="status-btn" data-filter="completed">
                âœ… å·²å®Œæˆ (<span id="countCompleted">0</span>)
            </button>
            <button class="status-btn" data-filter="uncompleted">
                â³ æœªå®Œæˆ (<span id="countUncompleted">--</span>)
            </button>
        </div>
    </div>

    <div class="grid-container" id="article-grid">
        <!-- JavaScript ç”¢ç”Ÿæ–‡ç« å¡ç‰‡ -->
    </div>

    <!-- éš±è—çš„ç®¡ç†è€… Emoji æŒ‰éˆ• (åŸæœ‰åŠŸèƒ½: åŒ¯å‡º) - å³ä¸‹è§’ -->
    <div id="admin-trigger" onclick="adminExportTrigger()">ğŸ¥¸</div>

    <!-- æ–°å¢ï¼šéš±è—çš„å¾Œå°é€£çµ Emoji æŒ‰éˆ• (åŠŸèƒ½: è·³è½‰åˆ° admin.html) - å·¦ä¸‹è§’ -->
    <div id="admin-link-btn" onclick="window.location.href='admin.html'">âš™ï¸</div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, increment, setDoc, getDoc, query, where, getDocs, orderBy, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase è¨­å®š
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDpNO7HktKVmMRAEwiKlU1gJ6RTb9qaUm4",
            authDomain: "shimen-pirls.firebaseapp.com",
            projectId: "shimen-pirls",
            storageBucket: "shimen-pirls.firebasestorage.app",
            messagingSenderId: "908294261992",
            appId: "1:908294261992:web:948474ea7c2a662a778d5d"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : "shimen-pirls";
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);


        const COLLECTION_NAME = 'pirls_stats';

        // ç²å–åŸºç¤è·¯å¾‘ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼Œæ”¯æŒä»»æ„å­è·¯å¾‘éƒ¨ç½²ï¼‰
const getBasePath = () => {
    const pathname = window.location.pathname;
    
    // ç§»é™¤æ–‡ä»¶åï¼Œåªä¿ç•™ç›®éŒ„è·¯å¾‘
    // ä¾‹å¦‚ï¼š/smes/PIRLS2/index.html â†’ /smes/PIRLS2
    //       /apps/reading/upload.html â†’ /apps/reading
    const lastSlashIndex = pathname.lastIndexOf('/');
    const dir = pathname.substring(0, lastSlashIndex);
    
    // å¦‚æœæ˜¯æ ¹ç›®éŒ„ä¸‹çš„æ–‡ä»¶ï¼ˆå¦‚ /index.htmlï¼‰ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    if (!dir || dir === '') return '';
    
    return dir;
};
const BASE_PATH = getBasePath();

        // æ–‡ç« è³‡æ–™ - å‹•æ…‹å¾ questions.json è¼‰å…¥
        let articles = [];

        // åˆå§‹è¼‰å…¥
        (async function () {
            try {
                const response = await fetch(`${BASE_PATH}/data/questions.json`);
                if (response.ok) {
                    const allQuestions = await response.json();
                    articles = allQuestions.map(q => ({ id: q.id, title: q.title }));
                    console.log(`[å‹•æ…‹è¼‰å…¥] æˆåŠŸè¼‰å…¥ ${articles.length} ç¯‡æ–‡ç« `);
                    if (document.getElementById('article-grid')) {
                        renderGrid();
                    }
                } else {
                    console.warn('[å‹•æ…‹è¼‰å…¥] questions.json è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é™ç´šè³‡æ–™');
                    articles = Array.from({ length: 47 }, (_, i) => ({ id: i + 1, title: `ç¯‡ç«  ${i + 1}` }));
                }
            } catch (e) {
                console.error('[å‹•æ…‹è¼‰å…¥] éŒ¯èª¤:', e);
                articles = Array.from({ length: 47 }, (_, i) => ({ id: i + 1, title: `ç¯‡ç«  ${i + 1}` }));
            }
        })();

        // v1.8: Completion Status Filter Logic
        let completedArticleIds = new Set();
        let currentUser = null;
        let currentFilter = 'all';

        async function loadCompletedArticles() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            if (!storedUser) {
                console.log('No user logged in, skipping completion check');
                // æœªç™»å…¥æ™‚ï¼Œæ›´æ–°ç¯©é¸å™¨è¨ˆæ•¸å™¨ç‚ºå¯¦éš›æ–‡ç« æ•¸é‡
                setTimeout(() => {
                    const cards = document.querySelectorAll('.grid-item');
                    const totalCount = cards.length;
                    const countAll = document.getElementById('countAll');
                    const countUncompleted = document.getElementById('countUncompleted');
                    if (countAll) countAll.textContent = totalCount;
                    if (countUncompleted) countUncompleted.textContent = totalCount;
                }, 100);
                return;
            }

            try {
                currentUser = JSON.parse(storedUser);

                // ä½¿ç”¨èˆ‡ quiz.js loadHistory() ç›¸åŒçš„è·¯å¾‘å’Œé‚è¼¯
                const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
                const q = query(publicResultsRef, orderBy('timestamp', 'desc'));

                const snapshot = await getDocs(q);
                completedArticleIds.clear();

                const targetClass = currentUser.class;
                const targetName = currentUser.name;

                snapshot.forEach(doc => {
                    const data = doc.data();

                    const recordClass = data.classId || data.class || "";
                    const recordName = data.studentName || data.name || "";

                    // æ¯”å°ç­ç´šå’Œå§“å
                    if (String(recordClass).trim() === String(targetClass).trim() &&
                        String(recordName).trim() === String(targetName).trim()) {

                        if (data.articleId && data.score === 100) {
                            completedArticleIds.add(parseInt(data.articleId));
                        }
                    }
                });

                console.log(`Found ${completedArticleIds.size} completed articles for ${targetClass} ${targetName}`);
                updateArticleStatus();
            } catch (error) {
                console.error('Error loading completed articles:', error);
            }
        }

        function updateArticleStatus() {
            const cards = document.querySelectorAll('.grid-item');
            let totalCount = cards.length;
            let completedCount = 0;
            let uncompletedCount = 0;

            cards.forEach(card => {
                const articleId = parseInt(card.dataset.articleId);
                const badge = card.querySelector('.completion-badge');

                if (completedArticleIds.has(articleId)) {
                    card.dataset.completed = 'true';
                    if (badge) badge.classList.add('show');
                    completedCount++;
                } else {
                    card.dataset.completed = 'false';
                    if (badge) badge.classList.remove('show');
                    uncompletedCount++;
                }
            });

            // Update counts
            const countAll = document.getElementById('countAll');
            const countCompleted = document.getElementById('countCompleted');
            const countUncompleted = document.getElementById('countUncompleted');

            if (countAll) countAll.textContent = totalCount;
            if (countCompleted) countCompleted.textContent = completedCount;
            if (countUncompleted) countUncompleted.textContent = uncompletedCount;

            // Apply current filter
            applyFilter(currentFilter);
        }

        function applyFilter(filter) {
            currentFilter = filter;
            const cards = document.querySelectorAll('.grid-item');

            cards.forEach(card => {
                const isCompleted = card.dataset.completed === 'true';

                if (filter === 'all') {
                    card.style.display = 'block';
                } else if (filter === 'completed') {
                    card.style.display = isCompleted ? 'block' : 'none';
                } else if (filter === 'uncompleted') {
                    card.style.display = isCompleted ? 'none' : 'block';
                }
            });

            // Update button states
            document.querySelectorAll('.status-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        /**
         * è‡ªå‹•ç¯©é¸æœªå®Œæˆæ–‡ç« ï¼ˆé‡å°å·²ç™»å…¥ç”¨æˆ¶ï¼‰
         * ç•¶ç”¨æˆ¶å·²ç™»å…¥ä¸”æœ‰å®Œæˆè¨˜éŒ„æ™‚ï¼Œè‡ªå‹•ç¯©é¸é¡¯ç¤ºæœªå®Œæˆçš„æ–‡ç« 
         */
        function autoFilterUncompletedForLoggedInUser() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            
            // åªå°å·²ç™»å…¥ä¸”æœ‰å®Œæˆè¨˜éŒ„çš„ç”¨æˆ¶æ‡‰ç”¨è‡ªå‹•ç¯©é¸
            if (storedUser && completedArticleIds.size > 0) {
                console.log('[Auto Filter] åµæ¸¬åˆ°å·²ç™»å…¥ç”¨æˆ¶ï¼Œè‡ªå‹•ç¯©é¸æœªå®Œæˆæ–‡ç« ');
                applyFilter('uncompleted');
            } else {
                // æœªç™»å…¥æˆ–ç„¡å®Œæˆè¨˜éŒ„ï¼Œé¡¯ç¤ºå…¨éƒ¨
                console.log('[Auto Filter] æœªç™»å…¥ç”¨æˆ¶æˆ–ç„¡å®Œæˆè¨˜éŒ„ï¼Œé¡¯ç¤ºå…¨éƒ¨æ–‡ç« ');
                applyFilter('all');
            }
        }


        // Initialize filter buttons
        function initializeFilterButtons() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    applyFilter(this.dataset.filter);
                });
            });
        }



        // å·¥å…·å‡½å¼ï¼šæ•¸å­—è½‰ä¸­æ–‡
        function numberToChinese(num) {
            const digits = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
            const n = parseInt(num);
            if (isNaN(n)) return '';
            if (n <= 0) return '';
            if (n < 10) return digits[n];
            if (n < 20) return 'å' + digits[n % 10];
            if (n < 100) {
                const ten = Math.floor(n / 10);
                const unit = n % 10;
                return digits[ten] + 'å' + digits[unit];
            }
            return num.toString();
        }

        // å·¥å…·å‡½å¼ï¼šæ ¼å¼åŒ–ç­ç´šå­—ä¸² (e.g. 1, 2 -> ä¸€å¹´äºŒç­)
        function formatGradeClass(grade, cls) {
            const gNum = parseInt(grade);
            const cNum = parseInt(cls);

            // 1. å˜—è©¦æ¨™æº–è½‰æ› (æ•¸å­— -> ä¸­æ–‡)
            if (!isNaN(gNum) && !isNaN(cNum)) {
                return `${numberToChinese(gNum)}å¹´${numberToChinese(cNum)}ç­`;
            }

            // 2. å¦‚æœè¼¸å…¥å·²ç¶“åŒ…å«ä¸­æ–‡ (e.g. "ä¸€å¹´", "1ç­")ï¼Œåšç°¡å–®æ¸…ç†åˆä½µ
            const gStr = String(grade || "");
            const cStr = String(cls || "");

            if (gStr.includes('å¹´') || cStr.includes('ç­')) {
                // é¿å…å‡ºç¾ "ä¸€å¹´å¹´" æˆ– "ä¸€ç­ç­"
                const cleanG = gStr.endsWith('å¹´') ? gStr : gStr + 'å¹´';
                const cleanC = cStr.endsWith('ç­') ? cStr : cStr + 'ç­';
                return `${cleanG}${cleanC}`;
            }

            // 3. è¬ä¸€ç„¡æ³•è§£æï¼Œå›å‚³åŸå§‹çµ„åˆ
            return `${grade}å¹´${cls}ç­`;
        }

        // ----- ç™»å‡ºåŠŸèƒ½ -----
        window.logoutUser = async function () {
            console.log("logoutUser function called!"); // DEBUG
            const storedUser = localStorage.getItem('shimen_pirls_user');
            console.log("storedUser:", storedUser); // DEBUG
            console.log("auth.currentUser:", auth.currentUser); // DEBUG

            if (!storedUser && !auth.currentUser) {
                alert("ç›®å‰å°šæœªç™»å…¥ã€‚");
                return;
            }

            // ç›´æ¥åŸ·è¡Œç™»å‡ºï¼Œç§»é™¤confirmå°è©±æ¡†ï¼ˆå› ç‚ºè¢«ç€è¦½å™¨é˜»æ­¢ï¼‰
            console.log("Executing logout..."); // DEBUG
            localStorage.removeItem('shimen_pirls_user');
            try {
                await signOut(auth);
                console.log("Firebase signOut successful"); // DEBUG
            } catch (e) {
                console.log("Sign out error (ignored):", e);
            }
            console.log("Reloading page..."); // DEBUG
            window.location.reload();
        };

        // ----- ç®¡ç†è€…å¾Œå°åŒ¯å‡ºåŠŸèƒ½ (å¼·åŠ›è£œå…¨ç‰ˆ) -----
        // æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä¿ç•™ä½†å…§éƒ¨é‚è¼¯ä¹Ÿæ”¹ç‚ºè®€å– public data ä»¥ä¿æŒä¸€è‡´
        window.adminExportTrigger = async function () {
            const password = prompt("ğŸ”’ ç®¡ç†è€…å°ˆç”¨\nè«‹è¼¸å…¥å¾Œå°é©—è­‰å¯†ç¢¼ï¼š");
            if (password !== "034711752") {
                if (password !== null) alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                return;
            }

            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('active');

            try {
                // 1. æ’ˆå– Public Stats (æ–‡ç« é»é–±æ•¸)
                const statsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME));
                const articleStats = {};
                statsSnapshot.forEach(doc => {
                    const aid = doc.id.replace('pirls_', '');
                    articleStats[aid] = doc.data().count || 0;
                });

                // 2. æ’ˆå–æ‰€æœ‰ä½œç­”ç´€éŒ„ (æ”¹ç”¨ public data è·¯å¾‘ï¼Œèˆ‡ admin.html ä¸€è‡´)
                const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
                // é è¨­ä¾æ™‚é–“æ’åº
                const q = query(publicResultsRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert("è³‡æ–™åº«ä¸­ç›®å‰æ²’æœ‰ä»»ä½•ä½œç­”ç´€éŒ„ã€‚");
                    overlay.classList.remove('active');
                    return;
                }

                // ç”¢ç”Ÿ CSV
                let csvContent = "\uFEFF";
                csvContent += "=== å­¸ç”Ÿä½œç­”æ˜ç´°è¡¨ ===\n";
                csvContent += "ç­ç´š,å§“å,æ–‡ç« ç·¨è™Ÿ,æ–‡ç« æ¨™é¡Œ,åˆ†æ•¸,ä½œç­”æ™‚é–“(ç§’),ä½œç­”æ—¥æœŸ,ä½œç­”æ™‚æ®µ(24Hå€é–“)\n";

                const summary = { totalAttempts: 0, totalScore: 0, articleUsage: {} };

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    // admin.html é‚è¼¯ï¼šdata.classId || data.class
                    const rawClass = data.classId || data.class || "æœªåˆ†ç­";
                    const rawName = data.studentName || data.name || "æœªå…·å";

                    const aid = data.articleId;
                    const title = data.articleTitle || articles.find(a => a.id == aid)?.title || `æ–‡ç«  ${aid}`;

                    let dateStr = "N/A";
                    let timeRangeStr = "N/A";

                    if (data.timestamp) {
                        const dateDate = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                        dateStr = dateDate.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        const hour = dateDate.getHours();
                        const hourStr = String(hour).padStart(2, '0');
                        timeRangeStr = `${hourStr}:00~${hourStr}:59`;
                    }

                    const row = [
                        `"${rawClass}"`,
                        `"${rawName}"`,
                        aid,
                        `"${title}"`,
                        data.score || 0,
                        data.timeTakenSeconds || 0,
                        `"${dateStr}"`,
                        `"${timeRangeStr}"`
                    ];
                    csvContent += row.join(",") + "\n";

                    summary.totalAttempts++;
                    summary.totalScore += (data.score || 0);

                    if (!summary.articleUsage[aid]) summary.articleUsage[aid] = { attempts: 0, sumScore: 0, sumTime: 0 };
                    summary.articleUsage[aid].attempts++;
                    summary.articleUsage[aid].sumScore += (data.score || 0);
                    summary.articleUsage[aid].sumTime += (data.timeTakenSeconds || 0);
                });

                csvContent += "\n\n=== å„æ–‡ç« å…¨ç«™çµ±è¨ˆæ•¸æ“š ===\n";
                csvContent += "æ–‡ç« ç·¨è™Ÿ,æ–‡ç« æ¨™é¡Œ,å…¨ç«™ç´¯ç©é»æ“Šäººæ¬¡(View),ç¸½ä½œç­”æ¬¡æ•¸,å¹³å‡æ­£ç¢ºç‡(åˆ†æ•¸),å¹³å‡ä½œç­”æ™‚é–“(ç§’)\n";

                articles.forEach(article => {
                    const stat = summary.articleUsage[article.id] || { attempts: 0, sumScore: 0, sumTime: 0 };
                    const viewCount = articleStats[article.id] || 0;
                    const avgScore = stat.attempts ? (stat.sumScore / stat.attempts).toFixed(1) : 0;
                    const avgTime = stat.attempts ? (stat.sumTime / stat.attempts).toFixed(1) : 0;

                    csvContent += `${article.id},"${article.title}",${viewCount},${stat.attempts},${avgScore},${avgTime}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                const now = new Date();
                const timeStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                link.setAttribute("download", `PIRLS_FULL_ADMIN_EXPORT_${timeStr}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                console.error("Admin Export Error:", e);
                alert("åŒ¯å‡ºå¤±æ•—ï¼Œå¯èƒ½åŸå› ï¼š\n1. æ¬Šé™ä¸è¶³\n2. ç¶²è·¯é€£ç·šå•é¡Œ\n" + e.message);
            } finally {
                overlay.classList.remove('active');
            }
        };

        // ----- å€‹äººåŒ¯å‡ºåŠŸèƒ½ (ä¿®æ­£ç‰ˆï¼šè®€å– Public Data ä¸¦å‰ç«¯ç¯©é¸) -----
        window.exportUserRecords = async function () {
            const exportBtn = document.getElementById('export-btn');
            const storedUser = localStorage.getItem('shimen_pirls_user');

            if (!storedUser) {
                alert("ç›®å‰å°šæœªç™»å…¥ã€‚");
                return;
            }

            const userInfo = JSON.parse(storedUser);
            // ç›®æ¨™ç­ç´šèˆ‡å§“å
            const targetClass = userInfo.class;
            const targetName = userInfo.name;

            if (!targetClass || !targetName) {
                alert("ä½¿ç”¨è€…è³‡è¨Šä¸å®Œæ•´ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
                return;
            }

            try {
                exportBtn.disabled = true;
                exportBtn.classList.add('loading');
                exportBtn.textContent = 'â³ è³‡æ–™æœå°‹ä¸­...';

                // è®€å–æ‰€æœ‰ Public Results
                // æ³¨æ„ï¼šé›–ç„¶é€™æ˜¯è®€å–ã€Œå…¨éƒ¨ã€ï¼Œä½†æˆ‘å€‘åªåœ¨å‰ç«¯éæ¿¾å‡ºå±¬æ–¼è©²ä½¿ç”¨è€…çš„ã€‚
                // é€™ä¿è­‰äº†èˆ‡ Admin å¾Œå°çœ‹åˆ°çš„ä¸€è‡´æ€§ã€‚
                const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
                const q = query(publicResultsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    alert("ç›®å‰æ²’æœ‰ä»»ä½•ä½œç­”ç´€éŒ„ã€‚");
                    resetBtn();
                    return;
                }

                let csvContent = "\uFEFF";
                csvContent += "å­¸ç”Ÿç­ç´š,å­¸ç”Ÿå§“å,æ–‡ç« ç·¨è™Ÿ,æ–‡ç« æ¨™é¡Œ,æ¸¬é©—åˆ†æ•¸,ä½œç­”è€—æ™‚(ç§’),ç´€éŒ„æ™‚é–“\n";

                let foundCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // æ¬„ä½æ¯”å° (åƒè€ƒ admin.html)
                    const recordClass = data.classId || data.class || "";
                    const recordName = data.studentName || data.name || "";

                    // å¯¬é¬†æ¯”å° (trim å»ç©ºç™½)
                    if (String(recordClass).trim() == String(targetClass).trim() &&
                        String(recordName).trim() == String(targetName).trim()) {

                        foundCount++;

                        const aid = data.articleId;
                        const title = data.articleTitle || articles.find(a => a.id == aid)?.title || `æ–‡ç«  ${aid}`;

                        // æ ¼å¼åŒ–ç­ç´š
                        let finalClassStr = recordClass;
                        if (userInfo.grade && userInfo.class) {
                            finalClassStr = formatGradeClass(userInfo.grade, userInfo.class);
                        }

                        let dateStr = "N/A";
                        if (data.timestamp) {
                            if (data.timestamp.toDate) dateStr = data.timestamp.toDate().toLocaleString('zh-TW');
                            else if (typeof data.timestamp === 'string') dateStr = new Date(data.timestamp).toLocaleString('zh-TW');
                        }

                        const row = [
                            `"${finalClassStr}"`,
                            `"${recordName}"`,
                            aid,
                            `"${title}"`,
                            data.score || 0,
                            data.timeTakenSeconds || 0,
                            `"${dateStr}"`
                        ];
                        csvContent += row.join(",") + "\n";
                    }
                });

                if (foundCount === 0) {
                    alert(`æŸ¥ç„¡ [${targetClass} ${targetName}] çš„ä½œç­”ç´€éŒ„ã€‚\nè«‹ç¢ºèªæ‚¨ç™»å…¥çš„ç­ç´šå§“åæ˜¯å¦èˆ‡ä¹‹å‰ä½œç­”æ™‚å®Œå…¨ä¸€è‡´ã€‚`);
                    resetBtn();
                    return;
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute("download", `PIRLSæ­·ç¨‹_${userInfo.name}_${today}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                console.error("Export failed:", e);
                alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n" + e.message);
            } finally {
                resetBtn();
            }

            function resetBtn() {
                exportBtn.disabled = false;
                exportBtn.classList.remove('loading');
                exportBtn.innerHTML = 'ğŸ“¥ åŒ¯å‡ºæˆ‘çš„æ­·ç¨‹';
            }
        };

        // è™•ç†ä¸Šä¸€é å¿«å–å•é¡Œ
        window.addEventListener('pageshow', (event) => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
            checkUserGreeting();
            if (localStorage.getItem('shimen_pirls_user')) {
                loadUserProgress();
            }
        });

        // æª¢æŸ¥ LocalStorage ä¸­çš„ä½¿ç”¨è€…è³‡è¨Š
        function checkUserGreeting() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            const badge = document.getElementById('user-greeting-badge');
            const exportBtn = document.getElementById('export-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    let displayClass = user.class;
                    if (user.grade && user.class) {
                        displayClass = formatGradeClass(user.grade, user.class);
                    }

                    badge.style.display = 'inline-block';
                    badge.innerHTML = `ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ${displayClass} ${user.name}`;
                    if (exportBtn) exportBtn.style.display = 'inline-flex';
                    if (logoutBtn) logoutBtn.style.display = 'inline-flex';
                    return true;
                } catch (e) {
                    console.warn("User data corrupted", e);
                    badge.style.display = 'none';
                    if (exportBtn) exportBtn.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'none';
                    return false;
                }
            } else {
                badge.style.display = 'none';
                if (exportBtn) exportBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';
                return false;
            }
        }

        // æ¸²æŸ“å¡ç‰‡
        const gridContainer = document.getElementById('article-grid');
        function renderGrid() {
            gridContainer.innerHTML = articles.map(article => `
                <div class="grid-item" id="card-${article.id}" data-article-id="${article.id}" data-completed="false">
                    <div class="completion-badge" style="display: none;">
                        <span>âœ… å·²å®Œæˆ</span>
                    </div>
                    <div class="article-content">
                        <div class="article-title">${article.title}</div>
                    </div>
                    
                    <div class="stats-container">
                        <div class="article-public-stats">
                            <span>ç¯‡ç«  ${article.id}</span>
                            <span class="view-count-badge" id="badge-${article.id}">
                                ğŸ‘ï¸ <span id="count-${article.id}">--</span>
                            </span>
                        </div>
                        <div class="user-personal-stats" id="user-stat-${article.id}">
                            <span class="no-record">å°šæœªä½œç­”</span>
                        </div>
                    </div>
                </div>
            `).join('');

            articles.forEach(article => {
                const card = document.getElementById(`card-${article.id}`);
                card.addEventListener('click', () => handleArticleClick(article.id));
            });
        }

        // é»æ“Šè™•ç†
        async function handleArticleClick(id) {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            // ç§»é™¤èº«ä»½ç¢ºèªå°è©±æ¡†ï¼Œè®“ä½¿ç”¨è€…ç›´æ¥é€²å…¥æ–‡ç« 

            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('active');

            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } catch (e) { console.log("Auth warning:", e); }
            }

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, `pirls_${id}`);
            setDoc(docRef, {
                count: increment(1),
                title: articles.find(a => a.id === id).title
            }, { merge: true }).catch(err => {
                console.warn("Background count update error:", err);
            });

            setTimeout(() => {
                window.location.href = `${BASE_PATH}/quiz.html?id=${id}`;
            }, 200);
        }

        // è¨‚é–±çµ±è¨ˆæ•¸æ“š (å…¨ç«™)
        function subscribeToStats() {
            const statsCollection = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);

            onSnapshot(statsCollection, (snapshot) => {
                let totalViews = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const idStr = doc.id.replace('pirls_', '');
                    const countElement = document.getElementById(`count-${idStr}`);
                    const countVal = data.count || 0;

                    if (countElement) {
                        countElement.textContent = countVal.toLocaleString();
                    }
                    totalViews += countVal;
                });
                document.getElementById('total-count').textContent = totalViews.toLocaleString();
            }, (error) => {
                console.warn("Stats Listener Error (Will retry):", error);
                document.getElementById('total-count').textContent = "---";
            });
        }

        // è¼‰å…¥ä½¿ç”¨è€…å€‹äººé€²åº¦ (ä¿®æ­£ç‰ˆï¼šè®€å– Public Data ä¸¦å‰ç«¯ç¯©é¸)
        async function loadUserProgress() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            if (!storedUser) return;

            const userInfo = JSON.parse(storedUser);
            const targetClass = userInfo.class;
            const targetName = userInfo.name;

            if (!targetClass || !targetName) return;

            try {
                // èˆ‡ admin.html ä¿æŒä¸€è‡´ï¼Œè®€å– public/data/quiz_results
                // é€™æ˜¯é—œéµä¿®æ­£é»
                const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
                // ç‚ºäº†æ•ˆèƒ½ï¼Œä¹Ÿè¨±å¯ä»¥åªæ’ˆæœ€è¿‘çš„ï¼Œä½†ç‚ºäº†å®Œæ•´æ€§å…ˆæ’ˆå…¨éƒ¨
                // admin.html ä¹Ÿæ˜¯æ’ˆå…¨éƒ¨ï¼Œæ‰€ä»¥é€™è£¡æ•ˆèƒ½æ‡‰è©²åœ¨å¯æ¥å—ç¯„åœ
                const q = query(publicResultsRef, orderBy('timestamp', 'desc'));

                const snapshot = await getDocs(q);

                if (snapshot.empty) return;

                const progressMap = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // æ¬„ä½åç¨±å°æ‡‰ admin.html çš„é‚è¼¯
                    const recordClass = data.classId || data.class || "";
                    const recordName = data.studentName || data.name || "";

                    // å‰ç«¯ç¯©é¸ï¼šå¦‚æœé€™ç­†è³‡æ–™å±¬æ–¼ç•¶å‰ç™»å…¥è€…
                    if (String(recordClass).trim() == String(targetClass).trim() &&
                        String(recordName).trim() == String(targetName).trim()) {

                        const aid = data.articleId;
                        const score = data.score || 0;
                        const time = data.timeTakenSeconds || 0;

                        if (!progressMap[aid]) {
                            progressMap[aid] = { maxScore: 0, totalTime: 0, attempts: 0 };
                        }

                        if (score > progressMap[aid].maxScore) {
                            progressMap[aid].maxScore = score;
                        }

                        progressMap[aid].totalTime += time;
                        progressMap[aid].attempts += 1;
                    }
                });

                // æ›´æ–° UI
                Object.keys(progressMap).forEach(articleId => {
                    const statEl = document.getElementById(`user-stat-${articleId}`);
                    if (statEl) {
                        const data = progressMap[articleId];
                        let icon = 'ğŸ“';
                        if (data.maxScore === 100) icon = 'ğŸ†';
                        else if (data.maxScore >= 60) icon = 'âœ…';

                        let timeDisplay = `${data.totalTime}ç§’`;
                        if (data.totalTime > 60) {
                            const mins = Math.floor(data.totalTime / 60);
                            const secs = data.totalTime % 60;
                            timeDisplay = `${mins}åˆ†${secs}ç§’`;
                        }

                        statEl.innerHTML = `
                            <div class="stat-badge score-text">${icon} ${data.maxScore}åˆ†</div>
                            <div class="stat-badge count-text">(${data.attempts}æ¬¡)</div>
                            <div class="stat-badge time-text">â±ï¸ ç´¯ç© ${timeDisplay}</div>
                        `;
                    }
                });

            } catch (e) {
                console.warn("Failed to load user progress:", e);
            }
        }

        // åˆå§‹åŒ–æµç¨‹
        renderGrid();
        checkUserGreeting();

        signInAnonymously(auth).then(() => {
            subscribeToStats();
            loadUserProgress();
        }).catch(e => {
            console.error("Connection Error:", e);
            document.getElementById('total-count').textContent = "é€£ç·šä¸­...";
        });

        particlesJS('particles-js', {
            particles: {
                number: { value: 60, density: { enable: true, value_area: 800 } },
                color: { value: "#ffffff" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: true },
                size: { value: 3, random: true },
                line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.3, width: 1 },
                move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out", bounce: false }
            },
            interactivity: {
                detect_on: "canvas",
                events: { onhover: { enable: true, mode: "repulse" }, onclick: { enable: true, mode: "push" }, resize: true },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
        });

        
        // v2.2: Initialize Progress Dashboard
        async function initProgressDashboard() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            if (!storedUser) {
                console.log('[ProgressDashboard] No user logged in');
                return;
            }
            
            // é¡¯ç¤ºå„€è¡¨æ¿
            const dashboardEl = document.getElementById('progressDashboard');
            if (dashboardEl) {
                dashboardEl.style.display = 'block';
            }
            
            // å‰µå»ºå¯¦ä¾‹
            window.progressDashboard = new ProgressDashboard('progressDashboard');
            
            // ç²å–é€²åº¦æ•¸æ“šï¼ˆä½¿ç”¨ç¾æœ‰çš„ loadUserProgress é‚è¼¯ç²å–çš„æ•¸æ“šï¼‰
            // æˆ‘å€‘éœ€è¦å°‡ loadUserProgress æ”¹ç‚ºè¿”å›æ•¸æ“š
            const progressData = await getProgressDataForDashboard();
            
            // åˆå§‹åŒ–
            await progressDashboard.init(progressData);
            
            console.log('[ProgressDashboard] Initialized successfully');
        }
        
        // ç²å–é€²åº¦æ•¸æ“šç”¨æ–¼å„€è¡¨æ¿
        async function getProgressDataForDashboard() {
            const storedUser = localStorage.getItem('shimen_pirls_user');
            if (!storedUser) return {};
            
            const userInfo = JSON.parse(storedUser);
            const targetClass = userInfo.class;
            const targetName = userInfo.name;
            
            if (!targetClass || !targetName) return {};
            
            try {
                const publicResultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results');
                const q = query(publicResultsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) return {};
                
                const progressMap = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const recordClass = data.classId || data.class || "";
                    const recordName = data.studentName || data.name || "";
                    
                    if (String(recordClass).trim() === String(targetClass).trim() && 
                        String(recordName).trim() === String(targetName).trim()) {
                        
                        const aid = data.articleId;
                        const score = data.score || 0;
                        const time = data.timeTakenSeconds || 0;
                        
                        if (!progressMap[aid]) {
                            progressMap[aid] = { maxScore: 0, totalTime: 0, attempts: 0 };
                        }
                        
                        if (score > progressMap[aid].maxScore) {
                            progressMap[aid].maxScore = score;
                        }
                        
                        progressMap[aid].totalTime += time;
                        progressMap[aid].attempts += 1;
                    }
                });
                
                return progressMap;
            } catch (e) {
                console.error('[ProgressDashboard] Failed to load progress data:', e);
                return {};
            }
        }


        // v1.8: Initialize completion filter on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('[Completion Filter] Page loaded, initializing...');
            await checkUserGreeting();
            renderGrid();
            initializeFilterButtons();
            await loadCompletedArticles();
            // v2.1: Auto-filter uncompleted articles for logged-in users
            autoFilterUncompletedForLoggedInUser();
            // v2.2: Initialize progress dashboard
            await initProgressDashboard();
        });
    </script>

    <!-- éŒ¯èª¤è™•ç†èˆ‡é€šçŸ¥ç³»çµ± -->
    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/progress-dashboard.js"></script>
    
    <!-- å¸³è™Ÿç¢ºèªæ¨¡çµ„ -->
    <script src="assets/js/account-confirmation.js"></script>
</body>

</html>