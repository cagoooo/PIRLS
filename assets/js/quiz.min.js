import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getFirestore,collection,doc,addDoc,setDoc,getDocs,query,orderBy,serverTimestamp,increment}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{getAuth,signInAnonymously}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";const firebaseConfig="undefined"!=typeof __firebase_config?JSON.parse(__firebase_config):{apiKey:"AIzaSyDpNO7HktKVmMRAEwiKlU1gJ6RTb9qaUm4",authDomain:"shimen-pirls.firebaseapp.com",projectId:"shimen-pirls",storageBucket:"shimen-pirls.firebasestorage.app",messagingSenderId:"908294261992",appId:"1:908294261992:web:948474ea7c2a662a778d5d"},appId="undefined"!=typeof __app_id?__app_id:"shimen-pirls",app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app);let startTime=new Date,currentUser=null,currentArticle=null,selectedAnswers=new Map;function initClassOptions(){const e=document.getElementById("classNumberSelect");if(!e)return;for(let t=1;t<=30;t++){const n=document.createElement("option");n.value=`${t}ç­`,n.textContent=`${t}ç­`,e.appendChild(n)}["å…¶ä»–"].forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}function renderArticle(){const e=document.getElementById("article-body");e&&currentArticle&&(e.innerHTML=currentArticle.content.map(e=>`<p>${e}</p>`).join(""))}function renderQuestions(){const e=document.getElementById("questions-container");e&&currentArticle&&(e.innerHTML=currentArticle.questions.map((e,t)=>{const n=t+1,s=["a","b","c","d","e"];return`\n            <div class="question" id="q-block-${n}">\n                <p>${n}. ${e.question}ï¼ˆ${e.type}ï¼‰</p>\n                ${e.options.map((e,t)=>`\n                    <label class="option">\n                        <input type="radio" name="q${n}" value="${s[t]}">\n                        ${e}\n                    </label>\n                `).join("")}\n                <div class="explanation" id="exp${n}"></div>\n            </div>\n        `}).join(""),selectedAnswers.clear(),setTimeout(initProgressTracking,100))}function checkUserLogin(){const e=localStorage.getItem("shimen_pirls_user");e?(currentUser=JSON.parse(e),updateUserUI(),document.getElementById("loginModal").style.display="none"):document.getElementById("loginModal").style.display="flex"}function updateUserUI(){if(!currentUser)return;const e=`${currentUser.class} ${currentUser.name}`,t=document.getElementById("mobile-user-name"),n=document.getElementById("desktop-user-name");t&&(t.textContent=e),n&&(n.textContent=e)}function checkAllAnswered(){if(!currentArticle)return!0;const e=currentArticle.questions.length,t=new Set;for(let n=1;n<=e;n++){document.querySelector(`input[name="q${n}"]:checked`)&&t.add(n)}const n=e-t.size;if(n>0){return confirm(`âš ï¸ é‚„æœ‰ ${n} é¡Œæœªä½œç­”\n\nç¢ºå®šè¦æäº¤ç­”æ¡ˆå—ï¼Ÿ\nï¼ˆæœªä½œç­”çš„é¡Œç›®å°‡è¢«è¦–ç‚ºç­”éŒ¯ï¼‰`)}return!0}async function loadHistory(){if(!currentUser||!currentArticle)return;const e=document.getElementById("history-list");if(!e)return;e.innerHTML='<div style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</div>';const t=currentUser.class,n=currentUser.name;try{const s=collection(db,"artifacts",appId,"public","data","quiz_results"),r=query(s,orderBy("timestamp","desc")),i=await getDocs(r);let o=[];if(i.forEach(e=>{const s=e.data(),r=s.classId||s.class||"",i=s.studentName||s.name||"";String(r).trim()===String(t).trim()&&String(i).trim()===String(n).trim()&&s.articleId==currentArticle.id&&o.push({...s,date:s.timestamp?s.timestamp.toDate():new Date})}),0===o.length)return void(e.innerHTML="<p style='color:#888; text-align:center;'>å°šç„¡æœ¬ç¯‡æ–‡ç« çš„ç·´ç¿’ç´€éŒ„ã€‚</p>");const a=Math.max(...o.map(e=>e.score||0)),c=Math.round(o.reduce((e,t)=>e+(t.score||0),0)/o.length);let l='<div class="history-items-container">';o.forEach(e=>{const t=e.score||0,n=e.timeTakenSeconds||0,s=t===a&&a>0;let r="low-score",i="âŒ";t>=90?(r="excellent",i="ğŸ†"):t>=70?(r="good",i="âœ…"):t>=60&&(r="pass",i="âš ï¸");const o=e.date.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"}),c=e.date.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:!0});l+=`\n                <div class="history-item ${s?"best-record":""}">\n                    ${s?'<div class="best-badge">ğŸ† æœ€ä½³</div>':""}\n                    <div class="history-main">\n                        <div class="history-badge ${r}">\n                            <span class="score-icon">${i}</span>\n                            <span class="score-value">${t}</span>\n                            <span class="score-unit">åˆ†</span>\n                        </div>\n                        <div class="history-details">\n                            <div class="detail-row">\n                                <span class="detail-icon">â±ï¸</span>\n                                <span class="detail-text">${n} ç§’</span>\n                            </div>\n                            <div class="detail-row">\n                                <span class="detail-icon">ğŸ—“ï¸</span>\n                                <span class="detail-text">${o} ${c}</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `}),l+="</div>",l+=`\n            <div class="history-summary">\n                <div class="summary-item">\n                    <span class="summary-label">æ¸¬é©—æ¬¡æ•¸</span>\n                    <span class="summary-value">${o.length}</span>\n                </div>\n                <div class="summary-item">\n                    <span class="summary-label">å¹³å‡åˆ†æ•¸</span>\n                    <span class="summary-value">${c} åˆ†</span>\n                </div>\n                <div class="summary-item">\n                    <span class="summary-label">æœ€é«˜åˆ†æ•¸</span>\n                    <span class="summary-value">${a} åˆ†</span>\n                </div>\n            </div>\n        `,e.innerHTML=l}catch(t){console.error("Load History Error:",t),e.innerHTML="<p style='color:red; font-size:0.8rem;'>è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</p>"}}function showError(e){const t=document.getElementById("loginModal");t&&(t.style.display="none");const n=document.getElementById("center-column");n&&(n.innerHTML=`\n            < div class="error-message" >\n                <h2>âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>\n                <p>${e}</p>\n                <p><a href="index.html">â† è¿”å›é¦–é </a></p>\n            </div >\n            `);const s=document.getElementById("right-column");s&&(s.style.display="none")}function showErrorMessage(e){const t=document.getElementById("loginModal");t&&(t.style.display="none");const n=document.getElementById("center-column");n&&(n.innerHTML=`\n            < div class="error-message-box" >\n                <div class="error-icon">âš ï¸</div>\n                <h2>ç™¼ç”ŸéŒ¯èª¤</h2>\n                <p class="error-text">${e}</p>\n                <div class="error-actions">\n                    <button onclick="location.reload()" class="retry-btn">ğŸ”„ é‡æ–°è¼‰å…¥</button>\n                    <a href="index.html" class="home-btn">ğŸ  è¿”å›é¦–é </a>\n                </div>\n            </div >\n            `);const s=document.getElementById("right-column");s&&(s.style.display="none")}function updateProgress(){if(!currentArticle)return;const e=currentArticle.questions.length,t=selectedAnswers.size,n=e>0?Math.round(t/e*100):0,s=document.getElementById("progressText"),r=document.getElementById("progressPercent"),i=document.getElementById("progressFill");s&&(s.textContent=`${t}/${e} é¡Œå·²ä½œç­”`),r&&(r.textContent=`${n}%`),i&&(i.style.width=`${n}%`,100===n?i.classList.add("complete"):i.classList.remove("complete"))}function initProgressTracking(){if(!currentArticle)return;const e=currentArticle.questions.length;for(let t=1;t<=e;t++){document.querySelectorAll(`input[name="q${t}"]`).forEach(e=>{e.addEventListener("change",function(){this.checked&&(selectedAnswers.set(t,this.value),updateProgress())})})}updateProgress()}window.addEventListener("DOMContentLoaded",async()=>{initClassOptions();const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"));if(t){try{const e=await fetch("data/questions.json?t="+Date.now());if(!e.ok)throw new Error("è¼‰å…¥é¡Œåº«å¤±æ•—");const n=await e.json();if(currentArticle=n.find(e=>e.id===t),!currentArticle)return void showError(`æ‰¾ä¸åˆ°ç·¨è™Ÿ ${t} çš„æ–‡ç« ï¼Œè«‹è¿”å›é¦–é é‡æ–°é¸æ“‡ã€‚`);renderArticle(),renderQuestions(),document.getElementById("article-title-display").textContent=`é–±è®€æ–‡ç« ï¼š${currentArticle.title}`,document.title=`é–±è®€ç†è§£ç·´ç¿’ï¼š${currentArticle.title}`}catch(e){console.error("è¼‰å…¥æ–‡ç« å¤±æ•—:",e);let t="âŒ ç„¡æ³•è¼‰å…¥æ–‡ç« å…§å®¹";return navigator.onLine?e.message.includes("fetch")||!response?t="âŒ ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨<br>è«‹ç¨å¾Œå†è©¦":e.message.includes("JSON")&&(t="âŒ è³‡æ–™æ ¼å¼éŒ¯èª¤<br>è«‹è¯çµ¡ç®¡ç†å“¡"):t="âŒ ç¶²è·¯é€£ç·šä¸­æ–·<br>è«‹æª¢æŸ¥ç¶²è·¯è¨­å®šå¾Œé‡è©¦",void showErrorMessage(t)}checkUserLogin();try{await signInAnonymously(auth),currentUser&&loadHistory()}catch(e){console.error("Auth Error",e)}}else showError("æ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ç«  IDï¼Œè«‹å¾é¦–é é¸æ“‡æ–‡ç« ã€‚")}),window.saveUserInfo=function(){const e=document.getElementById("gradeSelect").value,t=document.getElementById("classNumberSelect").value,n=document.getElementById("studentName").value.trim(),s=document.getElementById("seatNumber").value.trim();if(!e||!t||!n)return void alert("è«‹å®Œæ•´é¸æ“‡å¹´ç´šã€ç­ç´šä¸¦è¼¸å…¥å§“åï¼");const r=`${e}å¹´${t}`;currentUser={class:r,name:n,seat:s,fullId:`${r}-${s?s+"-":""}${n}`},localStorage.setItem("shimen_pirls_user",JSON.stringify(currentUser)),updateUserUI(),document.getElementById("loginModal").style.display="none",startTime=new Date,loadHistory()},window.resetUser=function(){console.log("resetUser called - switching user"),localStorage.removeItem("shimen_pirls_user"),location.reload()},window.checkAnswers=async function(){if(!checkAllAnswered())return;if(!currentUser)return alert("è«‹å…ˆç™»å…¥ï¼"),void location.reload();if(!currentArticle)return void alert("æ–‡ç« è³‡æ–™å°šæœªè¼‰å…¥ï¼");const e=document.getElementById("submitBtn");e.disabled=!0,e.textContent="è©•åˆ†èˆ‡å„²å­˜ä¸­...";let t=0,n={};const s=currentArticle.questions.length;for(let e=1;e<=s;e++){const s=document.querySelector(`input[name="q${e}"]:checked`),r=document.getElementById(`exp${e}`),i=s?s.value:"",o=currentArticle.questions[e-1].answer;n[`q${e}`]=i,r.className="explanation show",i===o?(t++,r.innerHTML="âœ… <strong>æ­£ç¢ºï¼</strong>",r.classList.add("correct"),r.classList.remove("incorrect")):(r.innerHTML=`âŒ <strong>éœ€è¦è¤‡ç¿’ï¼š</strong> ${currentArticle.questions[e-1].hint}`,r.classList.add("incorrect"),r.classList.remove("correct"))}const r=Math.round(t/s*100),i=Math.round((new Date-startTime)/1e3),o=document.getElementById("current-stats");o.style.display="block";let a=`\n        <h3 style="margin-top:0; color: #00008b;">ğŸ“ æœ¬æ¬¡æ¸¬é©—çµæœ</h3>\n        <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">\n            <div style="text-align: center;">\n                <div style="font-size: 2.5rem; font-weight: bold; color:${100===r?"#28a745":"#dc3545"}">${r}</div>\n                <div style="font-size: 0.9rem; color: #666;">å¾—åˆ†</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.5rem; font-weight: bold; color: #4169e1;">${i}ç§’</div>\n                <div style="font-size: 0.9rem; color: #666;">è€—æ™‚</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${t}/${s}</div>\n                <div style="font-size: 0.9rem; color: #666;">ç­”å°</div>\n            </div>\n        </div>\n        \n        <div style="border-top: 2px solid #ddd; padding-top: 15px; margin-top: 15px;">\n            <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“Š ç­”é¡Œè©³æƒ…</h4>\n    `;for(let e=1;e<=s;e++){const t=document.querySelector(`input[name="q${e}"]:checked`),n=t?t.value:"æœªä½œç­”",s=currentArticle.questions[e-1].answer,r=currentArticle.questions[e-1],i=n===s;a+=`\n            <div class="result-item ${i?"correct-result":"incorrect-result"}">\n                <div class="result-header">\n                    <span class="result-icon">${i?"âœ…":"âŒ"}</span>\n                    <span class="result-question-num">ç¬¬ ${e} é¡Œ</span>\n                    <span class="result-type">${r.type}</span>\n                </div>\n                <div class="result-body">\n                    <div class="result-row">\n                        <span class="result-label">é¡Œç›®ï¼š</span>\n                        <span>${r.question}</span>\n                    </div>\n                    <div class="result-row">\n                        <span class="result-label">ä½ çš„ç­”æ¡ˆï¼š</span>\n                        <span class="${i?"correct-answer":"wrong-answer"}">${"æœªä½œç­”"===n?"â“ æœªä½œç­”":n.toUpperCase()}</span>\n                    </div>\n                    ${i?"":`\n                    <div class="result-hint">\n                        ğŸ’¡ æç¤ºï¼š${r.hint}\n                    </div>\n                `}\n                </div>\n            </div>\n        `}a+='\n        </div>\n        <p style="text-align: center; margin: 20px 0 0 0; font-size: 0.9rem; color: #888;">æˆç¸¾å·²ä¸Šå‚³é›²ç«¯</p>\n    ',o.innerHTML=a;const c=o.getBoundingClientRect().top+window.pageYOffset-100;window.scrollTo({top:c,behavior:"smooth"});try{const e=collection(db,"artifacts",appId,"public","data","quiz_results"),t={classId:currentUser.class,studentName:currentUser.name,seatNumber:currentUser.seat,studentFullId:currentUser.fullId,articleId:currentArticle.id,articleTitle:currentArticle.title,score:r,answers:n,timeTakenSeconds:i,timestamp:serverTimestamp(),deviceInfo:navigator.userAgent};if(addDoc(e,t).catch(e=>console.warn("Public write failed:",e)),auth.currentUser){const e=collection(db,"artifacts",appId,"users",auth.currentUser.uid,"quiz_results");await addDoc(e,t)}const s=doc(db,"artifacts",appId,"public","data","pirls_stats",`pirls_${currentArticle.id}`);setDoc(s,{count:increment(1),title:currentArticle.title},{merge:!0}).catch(e=>console.warn("Stats update failed:",e)),setTimeout(loadHistory,500)}catch(e){console.error("Save Error:",e),alert("æˆç¸¾å·²é€å‡ºï¼Œä½†ç„¡æ³•å„²å­˜è‡³é›²ç«¯ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–è«‹ç®¡ç†å“¡æª¢æŸ¥è³‡æ–™åº«æ¬Šé™ã€‚")}finally{e.disabled=!1,e.textContent="å†æ¬¡æäº¤ (æ›´æ–°æˆç¸¾)",startTime=new Date}};