const getBasePath=()=>{const t=window.location.pathname,e=t.lastIndexOf("/"),n=t.substring(0,e);return n&&""!==n?n:""},BASE_PATH=getBasePath(),API_URL="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://127.0.0.1:3001":`${window.location.origin}${BASE_PATH}`;let parsedData=null,uploadedFile=null,existingQuestions=[],nextAvailableId=1,apiAvailable=!1;async function checkApiStatus(){try{(await fetch(`${API_URL}/api/questions`,{method:"GET"})).ok?(apiAvailable=!0,console.log("✅ API 伺服器已連線")):(apiAvailable=!1,console.log("⚠️ API 端點不可用，將使用下載模式"))}catch(t){apiAvailable=!1,console.log("⚠️ API 伺服器未啟動，將使用下載模式")}}async function loadExistingData(){try{if(apiAvailable){const t=await fetch(`${API_URL}/api/questions`);if(t.ok){const e=await t.json();return nextAvailableId=e.nextId||1,void(document.getElementById("total-count").textContent=e.count||0)}}const t=await fetch(`${BASE_PATH}/data/questions.json?t=`+Date.now());t.ok&&(existingQuestions=await t.json(),nextAvailableId=Math.max(...existingQuestions.map(t=>t.id),0)+1,document.getElementById("total-count").textContent=existingQuestions.length)}catch(t){console.error("載入題庫失敗:",t),document.getElementById("total-count").textContent="0"}}function setupDragDrop(){const t=document.getElementById("upload-zone");["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,t=>{t.preventDefault(),t.stopPropagation()})}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,()=>{t.classList.add("dragover")})}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,()=>{t.classList.remove("dragover")})}),t.addEventListener("drop",t=>{const e=t.dataTransfer.files;e.length>0&&handleFile(e[0])}),t.addEventListener("click",()=>{document.getElementById("file-input").click()})}function handleFileSelect(t){const e=t.target.files[0];e&&handleFile(e)}function handleFile(t){if(!t.name.match(/\.(xlsx|xls)$/i))return void alert("請上傳 Excel 檔案（.xlsx 或 .xls）");uploadedFile=t;const e=new FileReader;e.onload=t=>{try{const e=new Uint8Array(t.target.result);parseExcel(XLSX.read(e,{type:"array"}))}catch(t){console.error("解析失敗:",t),alert("檔案解析失敗，請確認格式正確。\n\n錯誤訊息："+t.message)}},e.readAsArrayBuffer(t)}function parseExcel(t){const e=t.SheetNames[0],n=t.Sheets[e],o=XLSX.utils.sheet_to_json(n,{header:1});let s=0;for(let t=0;t<o.length;t++){const e=o[t],n=String(e[1]||""),a=String(e[6]||"");if(n.includes("閱讀素養題組")&&a.length>100){s=t;break}}if(0===s){let t=0;for(let e=0;e<o.length;e++){const n=String(o[e][0]||"");n.includes("編號")&&n.includes("必填")&&(t=e)}for(let e=t+1;e<o.length;e++){const t=String(o[e][0]||"");if(!isNaN(parseInt(t))&&!t.includes("_")){s=e;break}}}const a=o[s],i=a[5]||"",l=(a[6]||"").split("\n").map(t=>t.trim()).filter(t=>t.length>0),c=[];for(let t=s+1;t<o.length;t++){const e=o[t];if(String(e[0]||"").includes("_")){const t=e[8]||"",n=e[10]||"",o=e[12]||"",s=e[14]||"",a=e[16]||"",i=e[18]||"",l=String(e[20]||"").toLowerCase(),d=e[21]||"";if(t.trim()){const e=[n,o,s,a];i&&e.push(i);let r="直接提取訊息";d.includes("直接推論")?r="直接推論":d.includes("詮釋與整合")||d.includes("詮釋")?r="詮釋與整合":(d.includes("評估與批判")||d.includes("評估"))&&(r="評估與批判");let u=d;u&&!u.startsWith("提示")&&(u="提示："+u),c.push({question:t.trim(),type:r,options:e.filter(t=>t.trim()),answer:l.charAt(0),hint:u})}}}i&&0!==l.length&&0!==c.length?(parsedData={title:i,content:l,questions:c},showPreview()):alert("無法解析有效的題組資料，請確認檔案格式正確。")}function showPreview(){document.getElementById("preview-title").textContent=parsedData.title,document.getElementById("paragraph-count").textContent=parsedData.content.length,document.getElementById("preview-content").innerHTML=parsedData.content.map((t,e)=>`<p style="margin-bottom: 8px;"><strong>${e+1}.</strong> ${t.substring(0,100)}${t.length>100?"...":""}</p>`).join(""),document.getElementById("question-count").textContent=parsedData.questions.length,document.getElementById("preview-questions").innerHTML=parsedData.questions.map((t,e)=>`\n            <div class="question-item">\n                <strong>${e+1}.</strong> ${t.question}\n                <span class="question-type">${t.type}</span>\n            </div>\n        `).join(""),document.getElementById("article-id").placeholder=nextAvailableId,goToStep(2)}async function saveQuiz(){const t=document.getElementById("article-id"),e=parseInt(t.value)||nextAvailableId;if(apiAvailable&&uploadedFile)try{const t=new FormData;t.append("file",uploadedFile),t.append("articleId",e);const n=await fetch(`${API_URL}/api/upload`,{method:"POST",body:t}),o=await n.json();if(o.success)return document.getElementById("result-id").textContent=o.articleId,document.getElementById("result-title").textContent=o.title,document.getElementById("result-questions").textContent=o.questionCount+" 題",document.getElementById("test-link").href=o.testUrl,void goToStep(3);throw new Error(o.error||"儲存失敗")}catch(t){console.error("API 儲存失敗:",t),alert("API 儲存失敗："+t.message+"\n\n將切換到下載模式...")}const n=existingQuestions.findIndex(t=>t.id===e);if(-1!==n&&!confirm(`題組 ID ${e} 已存在，確定要覆蓋嗎？`))return;const o={id:e,title:parsedData.title,content:parsedData.content,questions:parsedData.questions};-1!==n?existingQuestions[n]=o:(existingQuestions.push(o),existingQuestions.sort((t,e)=>t.id-e.id));const s=JSON.stringify(existingQuestions,null,2),a=new Blob([s],{type:"application/json"}),i=URL.createObjectURL(a),l=`            { id: ${e}, title: "${parsedData.title}" }`;document.getElementById("result-id").textContent=e,document.getElementById("result-title").textContent=parsedData.title,document.getElementById("result-questions").textContent=parsedData.questions.length+" 題",document.getElementById("test-link").href=`${BASE_PATH}/quiz.html?id=${e}`;const c=document.createElement("a");c.href=i,c.download="questions.json",document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout(()=>{alert(`✅ questions.json 已下載！\n\n請執行以下步驟完成設定：\n\n1. 將下載的 questions.json 放入 data 資料夾（覆蓋舊檔案）\n\n2. 在 index.html 的 articles 陣列中新增：\n${l}`)},500),goToStep(3)}function goToStep(t){document.querySelectorAll(".step-content").forEach(t=>{t.classList.remove("active")}),document.querySelectorAll(".steps-indicator .step").forEach(t=>{t.classList.remove("active")}),document.getElementById(`step-${t}`).classList.add("active"),document.getElementById(`step-${t}-indicator`).classList.add("active");for(let e=1;e<t;e++)document.getElementById(`step-${e}-indicator`).classList.add("completed")}function resetUpload(){parsedData=null,document.getElementById("file-input").value="",document.getElementById("article-id").value="",loadExistingData(),document.querySelectorAll(".steps-indicator .step").forEach(t=>{t.classList.remove("active","completed")}),document.getElementById("step-1-indicator").classList.add("active"),document.querySelectorAll(".step-content").forEach(t=>{t.classList.remove("active")}),document.getElementById("step-1").classList.add("active")}async function syncToVM(){localStorage.getItem("vmUrl");if("false"!==localStorage.getItem("autoSync"))try{showSyncStatus("���b�P�B��u�W����...");const t=await fetch("/data/questions.json?t="+Date.now());if(!t.ok)throw new Error("�L�kŪ�� questions.json");const e=await t.json(),n=localStorage.getItem("adminToken");if(!n)throw new Error("���n�J�޲z��");const o=await fetch("/api/sync-from-local",{method:"POST",headers:{"Content-Type":"application/json",Authorization:n},body:JSON.stringify({questions:e})}),s=await o.json();if(!s.success)throw new Error(s.error);showSyncStatus("? �w�۰ʦP�B  ���D�ը�u�W����","success"),console.log("[Sync] �P�B���:  ���D��")}catch(t){console.error("[Sync] �P�B����:",t),showSyncStatus("?? �۰ʦP�B���ѡG"+t.message,"warning")}else console.log("?? �۰ʦP�B�w����")}function showSyncStatus(t,e="info"){let n=document.getElementById("sync-status");n||(n=document.createElement("div"),n.id="sync-status",n.style.cssText="position:fixed;bottom:20px;right:20px;background:#333;color:white;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;font-size:14px;max-width:300px",document.body.appendChild(n)),n.style.background="success"===e?"#00a86b":"warning"===e?"#ff9800":"#333",n.textContent=t,n.style.display="block","info"!==e&&setTimeout(()=>n.style.display="none",3e3)}document.addEventListener("DOMContentLoaded",async()=>{await checkApiStatus(),await loadExistingData(),setupDragDrop(),document.getElementById("file-input").addEventListener("change",handleFileSelect)}),window.resetUpload=resetUpload,window.saveQuiz=saveQuiz;