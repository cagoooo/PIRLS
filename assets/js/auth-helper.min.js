const AUTH_API="http://127.0.0.1:3001/api/admin",TOKEN_KEY="pirls_admin_token";async function showLoginModal(){return new Promise(t=>{const e=document.getElementById("passwordModal"),o=document.getElementById("adminPassword"),n=document.getElementById("passwordError");e.style.display="flex",o.value="",o.focus(),window.checkAdminPassword=async function(){const a=o.value.trim();if(!a)return n.textContent="請輸入密碼",void(n.style.display="block");try{const s=await fetch(`${AUTH_API}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:a})}),r=await s.json();r.success?(localStorage.setItem(TOKEN_KEY,r.token),e.style.display="none",console.log("[Auth] 登入成功，Token有效期:",r.expiresIn),t(!0)):(n.textContent=r.error,void 0!==r.remainingAttempts&&(n.textContent+=` (剩餘嘗試: ${r.remainingAttempts})`),n.style.display="block",o.value="",o.focus())}catch(t){console.error("[Auth] 登入錯誤:",t),n.textContent="登入失敗，請檢查網路連線",n.style.display="block"}},o.onkeypress=function(t){"Enter"===t.key&&checkAdminPassword()}})}async function verifyToken(){const t=localStorage.getItem(TOKEN_KEY);if(!t)return!1;try{return!!(await fetch(`${AUTH_API}/verify`,{headers:{Authorization:t}})).ok||(localStorage.removeItem(TOKEN_KEY),!1)}catch(t){return console.error("[Auth] Token驗證失敗:",t),!1}}async function ensureAuthenticated(){if(await verifyToken()){const t=document.getElementById("passwordModal");t&&(t.style.display="none"),window.checkAdminPassword=function(){console.log("[Auth] 已登录，无需重新验证")}}else await showLoginModal()}async function authenticatedFetch(t,e={}){const o=localStorage.getItem(TOKEN_KEY);if(!o)throw new Error("未登入");e.headers={...e.headers,Authorization:o};const n=await fetch(t,e);if(401===n.status){localStorage.removeItem(TOKEN_KEY),await showLoginModal();const o=localStorage.getItem(TOKEN_KEY);return e.headers.Authorization=o,fetch(t,e)}return n}function logout(){localStorage.removeItem(TOKEN_KEY),window.location.reload()}document.addEventListener("DOMContentLoaded",async()=>{await ensureAuthenticated()});